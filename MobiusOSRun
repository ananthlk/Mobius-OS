#!/bin/bash

# Mobius OS - Development Startup
# Usage: MobiusOSRun
# Works from any directory

# Find project root (resolve symlinks to actual script location)
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Resolve symlinks
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # If relative symlink, resolve relative to original directory
    if [[ "$SCRIPT_PATH" != /* ]]; then
        SCRIPT_PATH="$(dirname "${BASH_SOURCE[0]}")/$SCRIPT_PATH"
    fi
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"
cd "$PROJECT_ROOT"

echo "ðŸŒ€ Awakening Mobius OS..."
echo "   Project Root: $PROJECT_ROOT"

# 1. Kill existing processes on ports 3000 (Portal) and 8000 (Nexus)
echo "   [1/4] Clearing neural pathways (Ports 3000, 8000)..."
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
lsof -ti:8000 | xargs kill -9 2>/dev/null || true

# 2. Ensure Database is running
echo "   [2/4] Checking emotional memory (PostgreSQL)..."
brew services start postgresql@14 >/dev/null 2>&1 || true

# 3. Start Nexus (Backend)
echo "   [3/4] Ignition: Nexus (Brain)..."
if [ ! -f "$PROJECT_ROOT/venv311/bin/activate" ]; then
    echo "   âŒ Error: Virtual environment not found at $PROJECT_ROOT/venv311"
    echo "   Please create it first: python3 -m venv venv311"
    exit 1
fi

source "$PROJECT_ROOT/venv311/bin/activate"
export PYTHONPATH="$PROJECT_ROOT"
cd "$PROJECT_ROOT"
nohup uvicorn nexus.app:app --host 0.0.0.0 --port 8000 --reload > "$PROJECT_ROOT/nexus.log" 2>&1 &
NEXUS_PID=$!
echo "         (PID: $NEXUS_PID)"

# 4. Start Portal (Frontend)
echo "   [4/4] Opening eyes: Portal (Interface)..."
if [ ! -d "$PROJECT_ROOT/surfaces/portal" ]; then
    echo "   âŒ Error: Portal directory not found at $PROJECT_ROOT/surfaces/portal"
    exit 1
fi

cd "$PROJECT_ROOT/surfaces/portal"
nohup npm run dev > "$PROJECT_ROOT/portal.log" 2>&1 &
PORTAL_PID=$!
echo "         (PID: $PORTAL_PID)"
cd "$PROJECT_ROOT"

echo ""
echo "âœ¨ Mobius is Online."
echo "   -> Portal: http://localhost:3000"
echo "   -> Nexus:  http://localhost:8000"
echo "   -> Logs:   tail -f \"$PROJECT_ROOT/nexus.log\" \"$PROJECT_ROOT/portal.log\""
echo ""
echo "   To stop: kill $NEXUS_PID $PORTAL_PID"
echo "   PIDs saved to: $PROJECT_ROOT/.mobius_pids"
echo "$NEXUS_PID $PORTAL_PID" > "$PROJECT_ROOT/.mobius_pids"

